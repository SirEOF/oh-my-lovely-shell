#!/usr/bin/env python

'''
DNS Multi view resolver
    author: t57root @ www.hackshell.net
    resolve domain from multilocation
    data source: alibench.com
'''

import urllib2,json,time
import sys,os,traceback

def get_that(url,body):
    headers = { 'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:22.0) Gecko/20100101 Firefox/22.0',
        'Accept': 'application/json, text/javascript, */*; q=0.01',
        'Accept-Language': 'en-US,en;q=0.5',
        'Accept-Encoding': 'gzip, deflate',
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
        'X-Requested-With': 'XMLHttpRequest',
        'Referer': 'http://alibench.com/'}

    req = urllib2.Request(url,body)
    #for (k,v) in headers.items():
    #    req.add_header(k,v)
    req.headers = headers
    rep = urllib2.urlopen(req)
    return rep.read()

def add_job(domain):
    body = "task_from=self&traceroute_from=%0D%0A++++++++++++++++++++16777216++++++++++++++++&traceroute_from_name=%0D%0A++++++++++++++++++++%E5%85%B6%E4%BB%96%E5%85%B6%E4%BB%96++++++++++++++++&target="+domain+"&target2=&is_pk=false&ac=dns&isps%5B%5D=30&isps%5B%5D=19&isps%5B%5D=5&isps%5B%5D=0&isps%5B%5D=1&isps%5B%5D=18&isps%5B%5D=22&isps%5B%5D=4&isps%5B%5D=6&dns_name_server="
    url = "http://alibench.com/new_task.php"
    content = get_that(url,body)

    try:
        tmp_json = json.loads(content)
        url = "http://alibench.com"+tmp_json['data']
        task_ids = tmp_json['data'].split('/')[2]
    except Exception,e:
        print "Unexpected content received.\nContent:\n"+content+"\nTraceback:\n"
        print traceback.format_exc()
        sys.exit()
    return task_ids

def get_result(task_ids,ip_list):
    #Check if the job is done
    while True:
        body = 'task_ids='+task_ids+'&task_type=4'
        content = get_that("http://alibench.com/query_task.php",body)
        try:
            tmp_json = json.loads(content)
            complete = tmp_json['data'][0]['complete']
        except Exception,e:
            print "Unexpected content received.\nContent:\n"+content+"\nTraceback:\n"
            print traceback.format_exc()
            sys.exit()
        if complete == True:
            break
        else:
            tmp = tmp_json['data'][0]['data']
            for i in tmp:
                for j in i['ips']:
                    ip = j['ip']
                    if ip not in ip_list:
                        ip_list.append(ip)
            os.write(sys.stdout.fileno(),'.')
            time.sleep(2)

if __name__ == '__main__':
    print "Usage: "+sys.argv[0]+" domain\nEg: "+sys.argv[0]+" www.hackshell.net"
    len(sys.argv)==2 or sys.exit(1)
    domain = sys.argv[1]
    #Get the all the IPs
    ip_list=[]
    task = add_job(domain)
    get_result(task,ip_list)

    #deal with the result
    print "\nDomain "+domain+" has the following IPs:"
    print "="*10
    for ip in ip_list:
        print ip
