#!/bin/sh
:<<DESC
 Nmap multi-proc starter
 Author: t57root @ www.hackshell.net
DESC

MAX_PROC_NUM=50

PORT_TCP_LIST=(
21      #ftp
22
2222    #ssh
23      #telnet
53      #dns
80
81      
88
808
888
8080
8081
8888    #http
111     #portmap/rpcbind
443     #http with ssl
873     #rsync
2049    #nfs
3306
3307    #mysql
6379    #redis
11211   #memcache
27017   #mongodb
28017   #mongodb web interface
)
PORT_UDP_LIST=(
53      #dns
)

echo "Author: t57root @ www.hackshell.net"
echo -e "Usage: $0 ip_range_list\nEg: $0 127.0.0,192.168.1\n"
echo $1 |egrep -q "[1-9\.,]+" || exit 1

echo "Script started @ `date`"

oIFS=$IFS
IFS="$IFS,"
IP_PREFIX_LIST=$1
IP_PREFIX_LIST=(${IP_PREFIX_LIST[@]})
IFS=$oIFS
starttime=`date +%s`
for port in ${PORT_TCP_LIST[@]};do
    tcp_ports="${port},${tcp_ports}"
done
for port in ${PORT_UDP_LIST[@]};do
    udp_ports="${port},${udp_ports}"
done
echo 
echo "Target network: $1"
echo -e "Interested ports:\n\ttcp:$tcp_ports\n\tudp:$udp_ports"
echo 

printf "Starting scan @ 255.255.255.255"
for prefix in ${IP_PREFIX_LIST[@]};do
    mkdir $prefix 2> /dev/null
    for suffix in `seq 1 255`;do
        ip=$prefix.$suffix
        while [ `ps -ef|grep -v grep|grep nmap|wc -l` -ge $MAX_PROC_NUM ];do
            sleep 0.5
        done
        printf "\x08\x08\x08\x08\x08\x08\x08\x08\x08\x08\x08\x08\x08\x08\x08"
        printf "%15s" $ip
        nmap $ip -p T:${tcp_ports}U:${udp_ports} -sS -sU -Pn >& $prefix/$ip &
    done
done

printf "\nProcess(es) left:   "
while [ 1 ];do
    left=`ps -ef|grep -v grep|grep nmap|wc -l`
    printf "\x08\x08%02d" $left
    if [ $left -eq 0 ];then
        break
    fi
    sleep 0.1
done
echo 
endtime=`date +%s`
printf "\nAll job done. Run \`grep open */*\` to see the result.\n"
echo "Script ended @ `date` (Elapsed `echo $(($endtime-$starttime))`s)"
